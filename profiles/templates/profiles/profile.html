{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container">
    <div class="tabs">
        <a href="{% url 'profile' %}" class="active tab-link">Your Orders</a>
        <a href="{% url 'edit_profile' %}" class="tab-link">Edit your details</a>
        <a href="{% url 'account_change_password' %}" class="tab-link">Change password</a>
    </div>

    <h2>Welcome, {{ user.username }}!</h2>

    <div>
    <h3>Your Orders</h3>

    <table class="table table-striped">
        <thead>
            <tr>
                <th scope="col">Order</th>
                <th scope="col">Order Date</th>
                <th scope="col">Status</th>
                <th scope="col">Value</th>
            </tr>
        </thead>
        <tbody>
            {% for order in page_obj %}
            <tr data-order-id="{{ order.id }}" onclick="redirectToOrder(this)" style="cursor: pointer;">
                <td>
                    {{ order.order_number }}

                    {% if order.prepaid_label_url %}
                    <!-- Reprint Label Button -->
                    <button onclick="reprintLabel('{{ order.prepaid_label_url }}')" class="btn reprint-label-btn">
                        Free postage Label
                    </button>
                    {% endif %}
                    <!-- Print Label Button -->
                     {% if order.paid_by_sender %}
                    <button onclick="printLabel('{{ order.order_number }}')" class="btn print-label-btn">
                        Print Label
                    </button>
                    {% endif %}
                 
                   

                </td>
                <td>{{ order.date|date:"d/m/y" }}</td>
                <td>{{ order.status }}</td>
                <td>
                {% if order.revised_price %}
                <span style="text-decoration: line-through; color: #c82333;">£{{ order.total_price }}</span>
                {% else %}
                £{{ order.total_price }}
                {% endif %}
                </td>   
                {% if order.revised_price %}
                <td class="revised-price">
                    <p>Revised Price: £{{ order.revised_price }}</p>
                    <p>Reason: {{ order.revised_reason }}</p>

                    {% if order.user_response == "Accepted" or order.user_response == "Rejected" %}
                    <p class="user-response">You have already {{ order.user_response|lower }} the offer.</p>
                    {% else %}
                    <form method="post" action="">
                        {% csrf_token %}
                        <input type="hidden" name="order_id" value="{{ order.id }}">
                        <button type="submit" name="response" value="Accepted" class="btn btn-success">Accept</button>
                        <button type="submit" name="response" value="Rejected" class="btn btn-danger">Reject</button>
                    </form>
                    {% endif %}
                </td>
                {% else %}
                <td></td>
                {% endif %}
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" style="text-align: center;">No orders found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pagination Controls -->
    <div class="pagination">
        <span class="step-links">
            {% if page_obj.has_previous %}
            <a href="?page=1">&laquo; first</a>
            <a href="?page={{ page_obj.previous_page_number }}">previous</a>
            {% endif %}

            <span class="current">
                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
            </span>

            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}">next</a>
            <a href="?page={{ page_obj.paginator.num_pages }}">last &raquo;</a>
            {% endif %}
        </span>
    </div>
</div>


<h1>Sell Order Statuses</h1>
<div class="statuses-container">
    <div>
        <div class="status-item">
            <span class="status">Awaiting Delivery</span>
            <span class="description">Awaiting for your Gadget(s)</span>
        </div>
        <div class="status-item">
            <span class="status">Received</span>
            <span class="description">Gadget(s) received, not yet checked.</span>
        </div>
        <div class="status-item">
            <span class="status">Completed</span>
            <span class="description">Order complete, payment sent.</span>
        </div>
        <hr>
        <div class="status-item">
            <span class="status">Problem</span>
            <span class="description">Problem with your order.</span>
        </div>
        <div class="status-item">
            <span class="status">Returned</span>
            <span class="description">Gadget(s) have been returned.</span>
        </div>
    </div>

    <div>
        <div class="status-item">
            <span class="status">Quarantined</span>
            <span class="description">IMEI flagged as blocked, lost or stolen.</span>
        </div>
        <div class="status-item">
            <span class="status">Accepted</span>
            <span class="description">Amended offer has been accepted.</span>
        </div>
        <div class="status-item">
            <span class="status">Rejected</span>
            <span class="description">Your order has been rejected.</span>
        </div>
      <hr>
        <div class="status-item">
            <span class="status">Expired</span>
            <span class="description">We never received your Gadget(s) - 14 days.</span>
        </div>
        <div class="status-item">
            <span class="status">Rejected</span>
            <span class="description">Your order has been rejected.</span>
        </div>
    </div>
</div>
</div>

<style>



    h1 {
                font-size: 24px;
                color: #333;
                text-align: center;
                margin-bottom: 20px;
            }
        /* Tabs Styling */
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
    
        .tab-link {
            text-decoration: none;
            padding: 12px 24px;
            color: #333;
            font-weight: bold;
            margin-right: 20px;
            border-bottom: 2px solid transparent;
            transition: color 0.3s, border-color 0.3s;
        }
    
        .tab-link:hover {
            color: #d63384;
        }
    
        .tab-link.active {
            color: #d63384;
            border-bottom: 2px solid #d63384;
        }
    
        .statuses-container {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 30px;
                background-color: #fff;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
    
            .status-item {
                background-color: #f0f0f0;
                padding: 15px;
                border-radius: 8px;
                border-left: 4px solid #0073e6;
                border-right: 4px solid #0073e6;
                transition: 0.3s;
            }
    
            .status-item:hover {
                background-color: #e8f4fd;
                border-color: #005bb5;
            }
    
            .status {
                font-size: 1rem;
                font-weight: bold;
                margin-bottom: 5px;
                color: #0073e6;
            }
    
            .description {
                font-size: 0.9rem;
                color: #555;
                margin-left: 10px;
            }
    
            hr {
                grid-column: span 2;
                border: none;
                border-top: 2px dashed #ccc;
                margin: 20px 0;
            }
    
    
        /* Form Styling */
        .profile-form {
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        .print-label-btn {
            background-color: #0073e6;
            color: white;
            padding: 5px 10px;
            font-size: 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-left: 10px;
        }
    
        .print-label-btn:hover {
            background-color: #005bb5;
        }

        /* Revised Price Section Styling */
td.revised-price {
    padding: 15px;
    background-color: #f9f9f9;
    border-radius: 5px;
    border: 1px solid #ddd;
    text-align: center;
}

td.revised-price p {
    margin: 5px 0;
    font-size: 14px;
    color: #333;
}

/* Response Buttons Styling */
td.revised-price form {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 10px;
}

td.revised-price button {
    padding: 8px 16px;
    font-size: 14px;
    font-weight: bold;
    border-radius: 5px;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
}

td.revised-price button.btn-success {
    background-color: #28a745;
    color: white;
}

td.revised-price button.btn-success:hover {
    background-color: #218838;
    transform: scale(1.05);
}

td.revised-price button.btn-danger {
    background-color: #dc3545;
    color: white;
}

td.revised-price button.btn-danger:hover {
    background-color: #c82333;
    transform: scale(1.05);
}

/* User Response Message */
td.revised-price p.user-response {
    font-size: 14px;
    font-weight: bold;
    color: #555;
    margin-top: 10px;
}

.reprint-label-btn {
        background-color: #28a745; /* Green for reprint */
        color: white;
        padding: 5px 10px;
        font-size: 14px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
        margin-left: 10px;
    }

    .reprint-label-btn:hover {
        background-color: #218838;
    }
    </style>


<script>
    function printLabel(orderNumber) {
    const companyAddress = `
        <div style="font-family: Arial, sans-serif; text-align: left; margin: 30px; border: 2px dashed #000; padding: 20px; width: 90%; max-width: 600px;">
            <h2 style="text-align: center;">Shipping Label</h2>
            <p><strong>Order Number:</strong> ${orderNumber}</p>
            <p><strong>Recipient:</strong></p>
            <p>CashThatGadget</p>
            <p>123 Buyback Street</p>
            <p>Suite 456</p>
            <p>London, UK</p>
            <p>Postcode: ABCD 1234</p>
            <p style="margin-top: 30px; text-align: center; font-size: 14px;">
                Postage must be <strong>paid by sender</strong>.
            </p>
        </div>
    `;

    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Print Label</title>
                <style>
                    @media print {
                        @page {
                            margin: 0;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                        }
                        div {
                            border: 2px solid #000;
                        }
                    }
                </style>
            </head>
            <body onload="window.print(); window.close();">
                ${companyAddress}
            </body>
        </html>
    `);
    printWindow.document.close();
}

function reprintLabel(labelUrl) {
        if (!labelUrl) {
            alert("No label URL available for this order.");
            return;
        }

        const printWindow = window.open(labelUrl, '_blank');
        printWindow.onload = function () {
            printWindow.print();
        };
    }
function redirectToOrder(rowElement) {
    // Get the order ID from the data attribute of the clicked row
    const orderId = rowElement.getAttribute('data-order-id');

    // Manually construct the URL by using Django's URL pattern for the view
    const url = "/profile/order/" + orderId + "/";

    // Redirect to the generated URL
    window.location.href = url;
}

function submitResponse(response) {
        const form = document.getElementById('response-form');
        const formData = new FormData(form);
        formData.append('response', response);

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value,
            },
        })
            .then(response => response.json())
            .then(data => {
                // Handle success or error here
                console.log(data);
                alert('Response submitted successfully!');
            })
            .catch(error => console.error('Error:', error));
    }
</script>
{% endblock %}
